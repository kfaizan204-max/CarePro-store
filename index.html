<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Uniform Stock Manager</title>
<style>
:root { --blue1:#89f7fe; --blue2:#66a6ff; }
body {
  font-family:sans-serif;
  margin:0; padding:0;
  background:linear-gradient(120deg,var(--blue1),var(--blue2));
  background-size:400% 400%;
  animation: gradientBG 15s ease infinite;
  color:#333;
}
@keyframes gradientBG {
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}
header, section {
  padding:15px; margin:10px;
  background:rgba(255,255,255,0.85);
  border-radius:10px; backdrop-filter:blur(5px);
}
table { width:100%; border-collapse:collapse; margin-top:10px;}
th,td { border:1px solid #aaa; padding:6px; text-align:center;}
input, select { width:100%; padding:5px; margin:2px 0;}
button {
  padding:6px 12px; margin:4px;
  border:none; border-radius:6px;
  background:#66a6ff; color:#fff; cursor:pointer; font-weight:bold;
}
button:hover { background:#89f7fe; color:#000;}
#saveMsg { color:green; font-weight:bold; display:none; }
</style>
</head>
<body>

<header>
  <h1>Uniform Stock Manager</h1>
</header>

<section>
<h2>Stock Summary</h2>
<div style="text-align:right; margin-bottom:8px;">
  <input type="file" id="csvFile" accept=".csv" style="display:none" onchange="importCSV(event)">
  <button onclick="document.getElementById('csvFile').click()">ðŸ“‚ Import CSV</button>
  <button onclick="exportCSV()">ðŸ“¤ Export CSV</button>
  <button onclick="saveStock()">ðŸ’¾ Update Stock Sheet</button>
  <span id="saveMsg">âœ… Saved successfully!</span>
</div>

<table id="stockTable">
<thead>
<tr><th>#</th><th>Item</th><th>Added</th><th>Delivered</th><th>Available</th></tr>
</thead>
<tbody></tbody>
</table>
</section>

<section>
<h2>Transactions</h2>
<form id="entryForm">
<input type="text" id="iqama" placeholder="Iqama" required>
<input type="text" id="emp" placeholder="Employee Name" required>
<input type="date" id="date" required>
<select id="itemSelect"></select>
<input type="number" id="qty" placeholder="Quantity" required min="1">
<input type="text" id="client" placeholder="Client">
<input type="text" id="note" placeholder="Note">
<button type="submit">âž• Add Transaction</button>
</form>

<table id="transTable">
<thead>
<tr><th>#</th><th>Iqama</th><th>Name</th><th>Date</th><th>Item</th><th>Qty</th><th>Client</th><th>Note</th><th>Action</th></tr>
</thead>
<tbody></tbody>
</table>
</section>

<script>
// ðŸ”— You can change these to your backend/API if needed later
const STOCK_API = "https://sheetdb.io/api/v1/2y1u7hp9ykzlq?sheet=Stock";
const TRAN_API = "https://sheetdb.io/api/v1/2y1u7hp9ykzlq?sheet=Transactions";

let stockData = [];
let transactions = [];

// --- Update Available Stock ---
function updateAvailable(){
  stockData.forEach(item=>{
    const delivered = transactions.filter(t=>t.Item===item.Item)
      .reduce((sum,t)=>sum+t.Qty,0);
    item.Delivered = delivered;
    item.Available = (item.Added||0) - delivered;
  });
}

// --- Render Stock ---
function renderStock(){
  const tbody = document.querySelector('#stockTable tbody');
  tbody.innerHTML='';
  stockData.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${r.Item}</td>
      <td><input type="number" value="${r.Added}" onchange="stockData[${i}].Added=+this.value"></td>
      <td>${r.Delivered}</td>
      <td>${r.Available}</td>`;
    tbody.appendChild(tr);
  });
  renderItemSelect();
}

// --- Render Item Select ---
function renderItemSelect(){
  const sel = document.getElementById('itemSelect');
  sel.innerHTML='';
  stockData.forEach(r=>{ if(r.Item) sel.innerHTML += `<option>${r.Item}</option>`; });
}

// --- Render Transactions ---
function renderTransactions(){
  const tbody = document.querySelector('#transTable tbody');
  tbody.innerHTML='';
  transactions.forEach((t,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML=`
      <td>${i+1}</td><td>${t.Iqama}</td><td>${t.Name}</td>
      <td>${t.Date}</td><td>${t.Item}</td><td>${t.Qty}</td>
      <td>${t.Client}</td><td>${t.Note}</td>
      <td><button onclick="deleteTransaction(${i})">ðŸ—‘</button></td>`;
    tbody.appendChild(tr);
  });
}

// --- Add Transaction ---
document.getElementById('entryForm').onsubmit = async function(e){
  e.preventDefault();
  const itemName = document.getElementById('itemSelect').value;
  const qty = parseInt(document.getElementById('qty').value);
  const stockRow = stockData.find(s=>s.Item===itemName);
  if(!stockRow || stockRow.Available < qty){
    alert("Not enough stock"); return;
  }

  const newTrans = {
    Iqama: iqama.value, Name: emp.value, Date: date.value,
    Item: itemName, Qty: qty,
    Client: client.value, Note: note.value
  };

  transactions.push(newTrans);
  updateAvailable();
  renderStock();
  renderTransactions();
  e.target.reset();

  try {
    await fetch(TRAN_API,{
      method:"POST", headers:{"Content-Type":"application/json"},
      body:JSON.stringify({data:[newTrans]})
    });
  } catch(err){ console.error(err); }
};

// --- Delete Transaction ---
async function deleteTransaction(index){
  transactions.splice(index,1);
  updateAvailable();
  renderStock();
  renderTransactions();
  await fetch(TRAN_API,{
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({data:transactions})
  });
}

// --- Save Stock (PUT update) ---
async function saveStock(){
  try {
    updateAvailable();
    const payload = {data: stockData.map(r=>({
      Item:r.Item, Added:+r.Added, Delivered:r.Delivered, Available:r.Available
    }))};
    const res = await fetch(STOCK_API,{
      method:"PUT", headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });
    if(res.ok){
      const msg=document.getElementById('saveMsg');
      msg.style.display='inline';
      setTimeout(()=>msg.style.display='none',2000);
    }else alert("âŒ Failed to save.");
  }catch(err){console.error(err);}
}

// --- Import CSV ---
function importCSV(event){
  const file = event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    const lines = e.target.result.split('\n').map(l=>l.trim()).filter(Boolean);
    const headers = lines.shift().split(',');
    stockData = lines.map(line=>{
      const cols = line.split(',');
      return {
        Item: cols[0],
        Added: +cols[1]||0,
        Delivered: +cols[2]||0,
        Available: +cols[3]||0
      };
    });
    renderStock();
  };
  reader.readAsText(file);
}

// --- Export CSV ---
function exportCSV(){
  let csv = "Item,Added,Delivered,Available\n";
  stockData.forEach(r=>{
    csv += `${r.Item},${r.Added},${r.Delivered},${r.Available}\n`;
  });
  const blob = new Blob([csv], {type: "text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "Uniform_Stock.csv";
  a.click();
}

// --- Load All Data ---
async function loadData(){
  try{
    const sRes = await fetch(STOCK_API);
    const sJson = await sRes.json();
    stockData = sJson.map(r=>({
      Item:r.Item, Added:+r.Added||0,
      Delivered:+r.Delivered||0, Available:+r.Available||0
    }));

    const tRes = await fetch(TRAN_API);
    const tJson = await tRes.json();
    transactions = tJson.map(t=>({
      Iqama:t.Iqama, Name:t.Name, Date:t.Date,
      Item:t.Item, Qty:+t.Qty, Client:t.Client, Note:t.Note
    }));

    updateAvailable();
    renderStock();
    renderTransactions();
  }catch(err){console.error(err);}
}

loadData();
</script>
</body>
</html>
