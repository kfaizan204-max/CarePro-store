<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Uniform Stock Manager</title>
<style>
body{font-family:sans-serif;margin:0;padding:0;background:#e0f7fa;color:#333;}
header,section{padding:10px 20px;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #aaa;padding:5px;text-align:center;}
input,select{width:100%;padding:5px;margin:2px 0;}
button{padding:5px 10px;margin:2px;}
.hidden{display:none;}
</style>
</head>
<body>

<header>
<h1>Uniform Stock Manager</h1>
</header>

<section id="stockSection">
<h2>Stock</h2>
<button onclick="addStockRow()">Add Row</button>
<button onclick="deleteStockRow()">Delete Row</button>
<table id="stockTable">
<thead>
<tr><th>Item</th><th>Added</th><th>Delivered</th><th>Available</th></tr>
</thead>
<tbody></tbody>
</table>
</section>

<section id="deliverySection">
<h2>Transactions</h2>
<form id="entryForm">
<input type="text" id="iqama" placeholder="Iqama" required>
<input type="text" id="emp" placeholder="Employee Name" required>
<input type="date" id="date" required>
<select id="itemSelect"></select>
<input type="number" id="qty" placeholder="Quantity" required min="1">
<input type="text" id="client" placeholder="Client">
<input type="text" id="note" placeholder="Note">
<button type="submit">Add Entry</button>
</form>

<table id="transTable">
<thead>
<tr><th>ID</th><th>Iqama</th><th>Name</th><th>Date</th><th>Item</th><th>Qty</th><th>Client</th><th>Note</th><th>Action</th></tr>
</thead>
<tbody></tbody>
</table>
</section>

<button onclick="saveEverything()">ðŸ’¾ Save Everything</button>

<script>
const API_BASE = "https://sheetdb.io/api/v1/2y1u7hp9ykzlq"; // SheetDB API

let stockData = [];
let transactions = [];

// --- Stock Functions ---
function updateDeliveredAndAvailable(){
  stockData.forEach(item=>{
    const delivered = transactions.filter(t=>t.item===item.Item).reduce((sum,t)=>sum+t.qty,0);
    item.Delivered = delivered;
    item.Available = (item.Added||0)-delivered;
  });
}

function renderStock(){
  const tbody = document.querySelector('#stockTable tbody');
  tbody.innerHTML='';
  stockData.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td contenteditable="true">${r.Item||''}</td>
    <td><input type="number" value="${r.Added||0}"></td>
    <td><input type="number" value="${r.Delivered||0}" readonly></td>
    <td><input type="number" value="${r.Available||0}" readonly></td>`;
    tbody.appendChild(tr);
  });
  renderItemSelect();
}

function addStockRow(){ stockData.push({Item:'',Added:0,Delivered:0,Available:0}); renderStock();}
function deleteStockRow(){ stockData.pop(); renderStock();}
function renderItemSelect(){
  const sel=document.getElementById('itemSelect'); sel.innerHTML='';
  stockData.forEach(r=>{ if(r.Item) sel.innerHTML+=`<option>${r.Item}</option>`; });
}

// --- Transactions Functions ---
function renderTransactions(){
  const tbody=document.querySelector('#transTable tbody'); tbody.innerHTML='';
  transactions.forEach((t,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${t.id}</td><td>${t.iqama}</td><td>${t.emp}</td><td>${t.date}</td><td>${t.item}</td><td>${t.qty}</td><td>${t.client}</td><td>${t.note}</td>
    <td><button onclick="deleteTrans(${i})">ðŸ—‘</button></td>`;
    tbody.appendChild(tr);
  });
}

function deleteTrans(i){
  const t=transactions[i];
  const stockRow = stockData.find(s=>s.Item===t.item);
  if(stockRow) stockRow.Delivered-=t.qty;
  transactions.splice(i,1);
  updateDeliveredAndAvailable();
  renderStock();
  renderTransactions();
}

// --- Form Submission ---
document.getElementById('entryForm').onsubmit=function(e){
  e.preventDefault();
  const itemName=document.getElementById('itemSelect').value;
  const qty=parseInt(document.getElementById('qty').value);
  const stockRow=stockData.find(s=>s.Item===itemName);
  if(!stockRow||stockRow.Available<qty){alert('Not enough stock'); return;}
  transactions.push({
    id:Date.now(), iqama:document.getElementById('iqama').value, emp:document.getElementById('emp').value,
    date:document.getElementById('date').value, item:itemName, qty:qty,
    client:document.getElementById('client').value, note:document.getElementById('note').value
  });
  updateDeliveredAndAvailable();
  renderStock();
  renderTransactions();
  e.target.reset();
};

// --- Save Everything ---
async function saveEverything(){
  // Update stockData from table
  const tbody = document.querySelector('#stockTable tbody');
  stockData = [];
  tbody.querySelectorAll('tr').forEach(tr=>{
    const c = tr.querySelectorAll('td');
    stockData.push({
      Item:c[0].innerText.trim(),
      Added:+c[1].querySelector('input').value,
      Delivered:+c[2].querySelector('input').value,
      Available:+c[3].querySelector('input').value
    });
  });
  updateDeliveredAndAvailable();
  renderStock();
  renderTransactions();

  try{
    // Save Stock
    await fetch(`${API_BASE}/Stock`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({data: stockData})
    });
    // Save Transactions
    if(transactions.length>0){
      await fetch(`${API_BASE}/Transactions`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({data: transactions})
      });
    }
    alert('âœ… Everything saved!');
  }catch(err){
    console.error(err);
    alert('âŒ Failed to save everything. Check SheetDB API & CORS.');
  }
}

// --- Load Data ---
async function loadData(){
  try{
    // Load Stock
    const resStock = await fetch(`${API_BASE}/Stock`);
    const stockJSON = await resStock.json();
    stockData = stockJSON.map(r=>({Item:r.Item,Added:+r.Added,Delivered:+r.Delivered,Available:+r.Available}));
    
    // Load Transactions
    const resTrans = await fetch(`${API_BASE}/Transactions`);
    const transJSON = await resTrans.json();
    transactions = transJSON.map(r=>({id:r.ID,emp:r.Name,date:r.Date,item:r.Item,qty:+r.Qty,client:r.Client,note:r.Note,iqama:""}));
    
  }catch(err){console.error(err);}
  updateDeliveredAndAvailable();
  renderStock();
  renderTransactions();
}

loadData();
</script>
</body>
</html>
