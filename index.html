<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Uniform Stock Manager</title>
<style>
body { font-family: sans-serif; margin:0; padding:0; background:#e0f7fa; color:#333; }
header, section { padding: 10px 20px; }
h1,h2 { margin:0 0 10px 0; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #aaa; padding: 5px; text-align: center; }
input, select { width: 100%; padding: 5px; margin: 2px 0; }
button { padding: 5px 10px; margin: 2px; }
.hidden { display:none; }
</style>
</head>
<body>

<header>
  <h1>Uniform Stock Manager</h1>
</header>

<section id="stockEntrySection">
<h2>Add Stock</h2>
<form id="stockForm">
<input type="text" id="sItem" placeholder="Item Name" required>
<input type="number" id="sQty" placeholder="Added Quantity" min="1" required>
<button type="submit">Add Stock</button>
</form>
</section>

<section id="stockSection">
<h2>Stock Summary</h2>
<table id="stockTable">
<thead>
<tr><th>RowNum</th><th>Item</th><th>Added</th><th>Delivered</th><th>Available</th><th>Action</th></tr>
</thead>
<tbody></tbody>
</table>
</section>

<section id="transactionSection">
<h2>Transactions</h2>
<form id="entryForm">
<input type="text" id="iqama" placeholder="Iqama" required>
<input type="text" id="emp" placeholder="Employee Name" required>
<input type="date" id="date" required>
<select id="itemSelect"></select>
<input type="number" id="qty" placeholder="Quantity" required min="1">
<input type="text" id="client" placeholder="Client">
<input type="text" id="note" placeholder="Note">
<button type="submit">Add Transaction</button>
</form>

<table id="transTable">
<thead>
<tr><th>RowNum</th><th>Iqama</th><th>Name</th><th>Date</th><th>Item</th><th>Qty</th><th>Client</th><th>Note</th><th>Action</th></tr>
</thead>
<tbody></tbody>
</table>
</section>

<script>
const STOCK_API = "https://sheetdb.io/api/v1/2y1u7hp9ykzlq?sheet=Stock";
const TRAN_API = "https://sheetdb.io/api/v1/2y1u7hp9ykzlq?sheet=Transactions";

let stockData = [];
let transactions = [];

// --- Update Available ---
function updateAvailable() {
  stockData.forEach(item => {
    const delivered = transactions.filter(t => t.Item === item.Item).reduce((sum, t) => sum + t.Qty, 0);
    item.Delivered = delivered;
    item.Available = (item.Added || 0) - delivered;
  });
}

// --- Render Stock ---
function renderStock() {
  const tbody = document.querySelector('#stockTable tbody');
  tbody.innerHTML = '';
  stockData.forEach((r,i) => {
    r.RowNum = i+1;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.RowNum}</td>
      <td>${r.Item}</td>
      <td>${r.Added}</td>
      <td>${r.Delivered}</td>
      <td>${r.Available}</td>
      <td><button onclick="deleteStock(${i})">ðŸ—‘ Delete</button></td>`;
    tbody.appendChild(tr);
  });
  renderItemSelect();
}

// --- Render Transactions ---
function renderTransactions() {
  const tbody = document.querySelector('#transTable tbody'); tbody.innerHTML='';
  transactions.forEach((t,i) => {
    t.RowNum = i+1;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${t.RowNum}</td><td>${t.Iqama}</td><td>${t.Name}</td><td>${t.Date}</td><td>${t.Item}</td><td>${t.Qty}</td>
    <td>${t.Client}</td><td>${t.Note}</td><td><button onclick="deleteTransaction(${i})">ðŸ—‘ Delete</button></td>`;
    tbody.appendChild(tr);
  });
}

// --- Item Select for Transactions ---
function renderItemSelect() {
  const sel = document.getElementById('itemSelect');
  sel.innerHTML='';
  stockData.forEach(r => { if(r.Item) sel.innerHTML += `<option>${r.Item}</option>`; });
}

// --- Stock Form Submit ---
document.getElementById('stockForm').onsubmit = async function(e){
  e.preventDefault();
  const item = document.getElementById('sItem').value.trim();
  const qty = parseInt(document.getElementById('sQty').value);
  if(!item || qty<=0) return;

  const existing = stockData.find(s=>s.Item === item);
  if(existing){
    existing.Added += qty;
  } else {
    stockData.push({Item:item, Added:qty, Delivered:0, Available:qty});
  }

  updateAvailable();
  renderStock();
  document.getElementById('sItem').value='';
  document.getElementById('sQty').value='';

  await saveStock();
};

// --- Transaction Form ---
document.getElementById('entryForm').onsubmit = async function(e){
  e.preventDefault();
  const itemName = document.getElementById('itemSelect').value;
  const qty = parseInt(document.getElementById('qty').value);
  const stockRow = stockData.find(s=>s.Item===itemName);
  if(!stockRow || stockRow.Available < qty){ alert("Not enough stock"); return; }

  const newTrans = {
    RowNum: transactions.length ? Math.max(...transactions.map(t=>t.RowNum))+1 : 1,
    Iqama: document.getElementById('iqama').value,
    Name: document.getElementById('emp').value,
    Date: document.getElementById('date').value,
    Item: itemName,
    Qty: qty,
    Client: document.getElementById('client').value,
    Note: document.getElementById('note').value
  };
  transactions.push(newTrans);
  updateAvailable();
  renderStock();
  renderTransactions();
  e.target.reset();

  await saveTransaction(newTrans);
};

// --- Delete Functions ---
async function deleteStock(index){
  const s = stockData.splice(index,1)[0];
  renderStock();
  try{
    await fetch(STOCK_API, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({data: stockData}) });
  }catch(err){ console.error(err); }
}

async function deleteTransaction(index){
  transactions.splice(index,1);
  updateAvailable();
  renderStock();
  renderTransactions();
  try{
    await fetch(TRAN_API, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({data: transactions}) });
  }catch(err){ console.error(err); }
}

// --- Save Functions ---
async function saveStock(){
  try{
    const payload = { data: stockData.map(s => ({
      Item: s.Item, Added: s.Added, Delivered: s.Delivered, Available: s.Available
    }))};
    await fetch(STOCK_API, {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload)});
  }catch(err){ console.error(err); }
}

async function saveTransaction(trans){
  try{
    const payload = { data: [trans] };
    await fetch(TRAN_API, {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload)});
  }catch(err){ console.error(err); }
}

// --- Load Data ---
async function loadStockData() {
  try{
    const sRes = await fetch(STOCK_API);
    const sJson = await sRes.json();
    stockData = sJson.map(r => ({Item:r.Item, Added:+r.Added, Delivered:+r.Delivered, Available:+r.Available}));
    const tRes = await fetch(TRAN_API);
    const tJson = await tRes.json();
    transactions = tJson.map(t => ({RowNum:+t.RowNum, Iqama:t.Iqama, Name:t.Name, Date:t.Date, Item:t.Item, Qty:+t.Qty, Client:t.Client, Note:t.Note}));
  }catch(err){ console.error(err); }
  updateAvailable();
  renderStock();
  renderTransactions();
}

// Load page
loadStockData();
</script>

</body>
</html>
