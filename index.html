<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Uniform Stock Manager</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
<style>
:root { --blue1:#89f7fe; --blue2:#66a6ff; --text:#333; }
body { font-family:'Roboto',sans-serif; margin:0; padding:0; background:linear-gradient(120deg,var(--blue1),var(--blue2)); background-size:400% 400%; animation:gradientBG 15s ease infinite; color:var(--text); }
@keyframes gradientBG{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
header{display:flex; align-items:center; justify-content:space-between; padding:10px 20px; background:rgba(255,255,255,0.8); backdrop-filter:blur(6px); flex-wrap:wrap; text-align:center;}
header img{height:60px;animation:breathe 3s ease-in-out infinite alternate;}
@keyframes breathe{0%{transform:scale(1);}50%{transform:scale(1.08);}100%{transform:scale(1);}}
header h1{font-size:24px;margin:10px auto;flex:1;text-align:center;}
button{padding:6px 12px;margin:3px;cursor:pointer;border:none;border-radius:5px;background:var(--blue2);color:#fff;font-weight:600;transition:.3s;}
button:hover{background:var(--blue1);color:#000;}
section{background:rgba(255,255,255,0.95);margin:20px;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.2);}
h2{text-align:center;margin-top:0;}
table{width:100%;border-collapse:collapse;margin-top:15px;}
th,td{border:1px solid #aaa;padding:8px;text-align:center;}
input,select{width:100%;padding:6px;margin-top:5px;box-sizing:border-box;border:1px solid #ccc;border-radius:4px;}
input[readonly]{background:#eee;}
.hidden{display:none;}
.rtl{direction:rtl;text-align:right;font-family:'Tajawal',sans-serif;}
</style>
</head>
<body>

<header>
  <img src="https://i.ibb.co/N0Bdr5N/Care-Pro-Logo-Jan-2025-Transparent.png" alt="Logo">
  <h1>Uniform Stock Manager</h1>
</header>

<section id="stockSection">
  <h2>Stock Details</h2>
  <div id="stockButtons" class="hidden">
    <button onclick="addStockRow()">Add Row</button>
    <button onclick="deleteStockRow()">Delete Row</button>
    <button onclick="saveEverything()">ðŸ’¾ Save Everything</button>
    <button onclick="exportStock()">Export Stock CSV</button>
  </div>
  <table id="stockTable">
    <thead>
      <tr>
        <th>Item</th>
        <th>Added Qty</th>
        <th>Delivered</th>
        <th>Available</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<section id="loginSection">
  <h2>Login to Delivery Section</h2>
  <div>
    <input type="text" id="userId" placeholder="User ID">
    <input type="password" id="password" placeholder="Password">
    <button onclick="login()">Login</button>
  </div>
</section>

<section id="deliverySection" class="hidden">
  <h2>Delivery / Return Entry</h2>
  <form id="entryForm">
    <input type="text" id="iqama" placeholder="Iqama" required>
    <input type="text" id="emp" placeholder="Employee Name" required>
    <input type="date" id="date" required>
    <select id="itemSelect"></select>
    <input type="number" id="qty" placeholder="Quantity" required min="1">
    <input type="text" id="client" placeholder="Client">
    <input type="text" id="note" placeholder="Note">
    <button type="submit">Add Entry</button>
  </form>

  <h2>Transactions</h2>
  <button onclick="exportReport()">Export Report CSV</button>
  <table id="transTable">
    <thead>
      <tr>
        <th>ID</th><th>Iqama</th><th>Name</th><th>Date</th><th>Item</th><th>Qty</th><th>Client</th><th>Note</th><th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<script>
let stockData = [];
let transactions = [];
const USERS = [{ id:'admin', password:'1234' }];
const API_BASE = "https://script.google.com/macros/s/AKfycbwjc52zQS2e3OJiTb6CAPJ4Aggtz8Y4IkXGRFup-M6AaKQ7jyXeYg1sK7v_4kFqbUND/exec"; // Apps Script URL

// Update stock availability
function updateDeliveredAndAvailable(){
  stockData.forEach(item => {
    const deliveredQty = transactions
      .filter(t => t.item === item.Item)
      .reduce((sum,t) => sum + t.qty,0);
    item.Delivered = deliveredQty;
    item.Available = (item.Added||0) - deliveredQty;
  });
}

// Render stock table
function renderStock(){
  const tbody=document.querySelector('#stockTable tbody');
  tbody.innerHTML='';
  stockData.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td contenteditable="true">${r.Item||''}</td>
      <td><input type="number" value="${r.Added||0}"></td>
      <td><input type="number" value="${r.Delivered||0}" readonly></td>
      <td><input type="number" value="${r.Available||0}" readonly></td>
    `;
    tbody.appendChild(tr);
  });
  renderItemSelect();
}

function addStockRow(){ stockData.push({Item:'',Added:0,Delivered:0,Available:0}); renderStock();}
function deleteStockRow(){ stockData.pop(); renderStock();}

// Render item dropdown
function renderItemSelect(){
  const select=document.getElementById('itemSelect');
  select.innerHTML='';
  stockData.forEach(r=>{if(r.Item) select.innerHTML+=`<option>${r.Item}</option>`;});
}

// Render transactions
function renderTransactions(){
  const tbody=document.querySelector('#transTable tbody');
  tbody.innerHTML='';
  transactions.forEach((t,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${t.id}</td>
      <td>${t.iqama}</td>
      <td>${t.emp}</td>
      <td>${t.date}</td>
      <td>${t.item}</td>
      <td>${t.qty}</td>
      <td>${t.client}</td>
      <td>${t.note}</td>
      <td><button onclick="deleteTrans(${i})">ðŸ—‘</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// Delete a transaction
function deleteTrans(i){
  const t=transactions[i];
  const stockRow=stockData.find(s=>s.Item===t.item);
  if(stockRow) stockRow.Delivered-=t.qty;
  transactions.splice(i,1);
  updateDeliveredAndAvailable();
  renderTransactions();
}

// Save everything to Google Sheet
async function saveEverything(){
  const tbody=document.querySelector('#stockTable tbody');
  stockData=[];
  tbody.querySelectorAll('tr').forEach(tr=>{
    const cells=tr.querySelectorAll('td');
    stockData.push({
      Item:cells[0].innerText.trim(),
      Added:parseInt(cells[1].querySelector('input').value)||0,
      Delivered:parseInt(cells[2].querySelector('input').value)||0,
      Available:parseInt(cells[3].querySelector('input').value)||0
    });
  });
  updateDeliveredAndAvailable();
  renderStock();
  renderTransactions();

  try{
    // Save stock
    await fetch(API_BASE,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(stockData)});
    // Save transactions
    if(transactions.length>0){
      await fetch(API_BASE,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'transactions',data:transactions})});
    }
    alert('âœ… Everything saved!');
  }catch(err){
    console.error(err);
    alert('âŒ Failed to save. Check Apps Script deployment and CORS.');
  }
}

// Form submission
document.getElementById('entryForm').onsubmit=async function(e){
  e.preventDefault();
  const itemName=document.getElementById('itemSelect').value;
  const qty=parseInt(document.getElementById('qty').value);
  const stockRow=stockData.find(s=>s.Item===itemName);
  if(!stockRow || stockRow.Available<qty){alert('Not enough stock'); return;}
  transactions.push({
    id:Date.now(),
    iqama:document.getElementById('iqama').value,
    emp:document.getElementById('emp').value,
    date:document.getElementById('date').value,
    item:itemName,
    qty:qty,
    client:document.getElementById('client').value,
    note:document.getElementById('note').value
  });
  updateDeliveredAndAvailable();
  renderStock();
  renderTransactions();
  e.target.reset();
};

// Login
function login(){
  const id=document.getElementById('userId').value.trim();
  const password=document.getElementById('password').value.trim();
  const user=USERS.find(u=>u.id===id && u.password===password);
  if(user){
    document.getElementById('deliverySection').classList.remove('hidden');
    document.getElementById('loginSection').style.display='none';
    document.getElementById('stockButtons').classList.remove('hidden');
    renderItemSelect();
    renderTransactions();
  } else alert('Invalid credentials');
}

// Load stock and transactions initially
async function loadStock(){
  try{
    const res=await fetch(API_BASE);
    const data=await res.json();
    stockData=data.stock || [];
    transactions=data.transactions || [];
  }catch(err){console.error(err);}
  updateDeliveredAndAvailable();
  renderStock();
  renderTransactions();
}

loadStock();

// CSV Export
function exportStock(){
  let csv='Item,Added,Delivered,Available\n';
  stockData.forEach(r=>csv+=`${r.Item},${r.Added},${r.Delivered},${r.Available}\n`);
  downloadCSV(csv,'stock.csv');
}
function exportReport(){
  let csv='ID,Iqama,Name,Date,Item,Qty,Client,Note\n';
  transactions.forEach(t=>csv+=`${t.id},${t.iqama},${t.emp},${t.date},${t.item},${t.qty},${t.client},${t.note}\n`);
  downloadCSV(csv,'transactions.csv');
}
function downloadCSV(csv,name){
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=name;
  a.click();
  URL.revokeObjectURL(a.href);
}
</script>

</body>
</html>
