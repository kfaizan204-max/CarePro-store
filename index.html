<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Uniform Stock Manager</title>
<style>
body { font-family: sans-serif; margin:0; padding:0; background:#e0f7fa; color:#333; }
header, section { padding: 10px 20px; }
h1,h2 { margin:0 0 10px 0; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #aaa; padding: 5px; text-align: center; }
input, select { width: 100%; padding: 5px; margin: 2px 0; }
button { padding: 5px 10px; margin: 2px; }
</style>
</head>
<body>

<header>
  <h1>Uniform Stock Manager</h1>
</header>

<section id="transactionSection">
<h2>Transactions</h2>
<form id="entryForm">
  <input type="text" id="iqama" placeholder="Iqama" required>
  <input type="text" id="emp" placeholder="Employee Name" required>
  <input type="date" id="date" required>
  <input type="number" id="rowNum" placeholder="Row Number (1-4)" min="1" max="4" required>
  <input type="text" id="item" placeholder="Item" required>
  <input type="number" id="qty" placeholder="Quantity" required min="1">
  <input type="text" id="client" placeholder="Client">
  <input type="text" id="note" placeholder="Note">
  <button type="submit">Add Transaction</button>
</form>

<table id="transTable">
<thead>
<tr><th>RowNum</th><th>Iqama</th><th>Name</th><th>Date</th><th>Item</th><th>Qty</th><th>Client</th><th>Note</th></tr>
</thead>
<tbody></tbody>
</table>
</section>

<script>
const TRAN_API = "https://sheetdb.io/api/v1/2y1u7hp9ykzlq?sheet=Transactions";

let transactions = [];

// Render transactions table
function renderTransactions() {
  const tbody = document.querySelector('#transTable tbody');
  tbody.innerHTML = '';
  transactions.forEach(t => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${t.RowNum}</td><td>${t.Iqama}</td><td>${t.Name}</td><td>${t.Date}</td>
      <td>${t.Item}</td><td>${t.Qty}</td><td>${t.Client}</td><td>${t.Note}</td>`;
    tbody.appendChild(tr);
  });
}

// Load data from SheetDB
async function loadData() {
  try {
    const res = await fetch(TRAN_API);
    const data = await res.json();
    transactions = data.map(t => ({
      RowNum: t.RowNum,
      Iqama: t.Iqama,
      Name: t.Name,
      Date: t.Date,
      Item: t.Item,
      Qty: t.Qty,
      Client: t.Client,
      Note: t.Note
    }));
    renderTransactions();
  } catch(err) { console.error(err); }
}

// Form submission
document.getElementById('entryForm').onsubmit = async function(e){
  e.preventDefault();
  const rowNum = parseInt(document.getElementById('rowNum').value);
  const existing = transactions.find(t=>t.RowNum === rowNum);
  if(existing){
    alert("❌ This Row Number already exists! Choose another.");
    return;
  }

  const newTrans = {
    RowNum: rowNum,
    Iqama: document.getElementById('iqama').value,
    Name: document.getElementById('emp').value,
    Date: document.getElementById('date').value,
    Item: document.getElementById('item').value,
    Qty: parseInt(document.getElementById('qty').value),
    Client: document.getElementById('client').value,
    Note: document.getElementById('note').value
  };

  try {
    const payload = { data: [newTrans] };
    const res = await fetch(TRAN_API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if(res.ok){
      transactions.push(newTrans);
      renderTransactions();
      alert("✅ Saved!");
      e.target.reset();
    } else {
      alert("❌ Failed to save.");
    }
  } catch(err){
    console.error(err);
    alert("❌ Network or API error.");
  }
}

// Load existing transactions on page load
loadData();
</script>

</body>
</html>
